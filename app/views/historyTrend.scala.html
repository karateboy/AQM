@* trendReport Template File *@
@(privilege: Privilege)
<div class="row">
   	<div class="col-lg-12">
    		<div class="panel-group" id="accordion">
        	<div class="panel panel-primary" id="paramPanel">
            	<div class="panel-heading panel-title" >
            		<a data-toggle="collapse" data-parent="#accordion" href="#reportParam">趨勢參數</a>	
                </div>
            	<div class="panel-body panel-collapse in" id="reportParam">
            		<h5>測站</h5>
            		<button id="select-all-monitors" class="btn btn-info">全選</button>
            		<div class="btn-group" data-toggle="buttons">
            			@for(m<-privilege.allowedMonitors){
            				<label class="btn btn-outline btn-primary dim">
								<input type="checkbox" name="monitor" id="@m">@Monitor.getDisplayName(m)</label>		
            			}
            		</div>
            		<br/>
					<h5>監測項目</h5>
					<button id="select-all-monitorTypes" class="btn btn-info">全選</button>
					<div class="btn-group" data-toggle="buttons">
					    @for(mt<-privilege.allowedMonitorTypes){
            				<label class="btn btn-outline btn-primary dim">
								<input type="checkbox" name="monitorType" id="@mt">@MonitorType.map(mt).desp</label>		
            			}
  
					</div>
					<br/>
					<h5>報表單位</h5>
           			<div class="btn-group" data-toggle="buttons">
            			@for(ru<-ReportUnit.values.toList.sorted){
            				<label class="btn btn-outline btn-primary dim">
								<input type="radio" name="reportUnit" id="@ru">@ReportUnit.map(ru)</label>		
            			}
            		</div>
 					<br/>
  					<h5>查詢區間</h5>
 					<div class="input-daterange input-group" id="datepicker">
                    	<span class="input-group-addon"><i class="fa fa-calendar"></i></span><input type="text" class="input-sm form-control" name="start" id="reportStart" required/>
                       	<span class="input-group-addon">至</span>
                        <input type="text" class="input-sm form-control" name="end" id="reportEnd" required/>                        
                    </div>
					<br/>
					<div>
						<button type="button" class="btn btn-primary" id="queryReport">查詢</button>
					</div>
            	</div>
        	</div>
        	<div class="panel panel-success" style="display:none" id="reportPanel">
            	<div class="panel-heading panel-title"" >
            		<a data-toggle="collapse" data-parent="#accordion" href="#monitorReport">歷史趨勢圖</a>	            		
                </div>
            	<div class="panel-body panel-collapse" id="monitorReport">
					<div id="reportDiv" align="center" style="overflow-x:auto">
					            		
            		</div>
            	</div>
        	</div> <!-- end of panel group -->
    	</div>
	</div>
</div>
<script src='@routes.Assets.at("js/highcharts/modules/exporting.js")'></script>
<script>
$( document ).ready(function() {
	$('#select-all-monitors').click(function(){
		$('.btn-group input[name="monitor"]').each(function(){
	            // toggle checkbox
	            $(this).prop('checked',!$(this).prop('checked'));
	            // toggle class
	            $(this).parents('label').toggleClass('active');
	        });
	});

	$('#select-all-monitorTypes').click(function(){
		$('.btn-group input[name="monitorType"]').each(function(){
	            // toggle checkbox
	            $(this).prop('checked',!$(this).prop('checked'));
	            // toggle class
	            $(this).parents('label').toggleClass('active');
	        });
	});
	
	$('#reportStart').datetimepicker({
		format: 'YYYY-MM-D HH:mm',
    	locale: "zh-TW"
	});
	$('#reportEnd').datetimepicker({
		format: 'YYYY-MM-D HH:mm',
    	locale: "zh-TW"
	});
    $("#reportStart").on("dp.change", function (e) {
        $('#reportEnd').data("DateTimePicker").minDate(e.date);
    });
    
    $("#reportEnd").on("dp.change", function (e) {
        $('#reportStart').data("DateTimePicker").maxDate(e.date);
    });


	var monitors, monitorTypes, reportUnit, reportStart, reportEnd;
	
	function validate(){
		monitors = $("input[name='monitor']:checked");

		if (monitors.length == 0) {
			alert("請選擇測站");
			return false;
		}

		monitorTypes = $("input[name='monitorType']:checked");
		if(monitorTypes.length == 0) {
			alert('請選擇測項');
			return false;
		}

		reportUnit = $("input[name='reportUnit']:checked").attr('id');
		if(!reportUnit) {
			alert("請選擇報表單位");
			return false;
		}
		
		reportStart = $('#reportStart').val();
		if(reportStart.length === 0){
			alert('請選擇開始日期');
			return false;
		}
		
		reportEnd = $('#reportEnd').val();
		if(reportStart.length === 0){
			alert('請選擇結束日期');
			return false;
		}

		if(reportUnit == "min"){
			var start = new Date(reportStart);
			var end = new Date(reportEnd);
			var diff = end.getTime()-start.getTime();
			if(diff > 1 * 24*60*60*1000){
				alert("分鐘查詢區間必須小於1天");
				return false;
			}
		}
		
		return true;
	}
	
	$('#queryReport').click(function(){
		if(!validate())
			return;
			
		$("#reportPanel").css('display','block');
		$("#reportParam").collapse();
		$("#reportPanel").collapse('show');

		$('#reportDiv').html('');
		$("body").css("cursor", "progress");

		var monitorParam='';
		for (var i = 0; i < monitors.length; i++) {
			if(monitorParam=='')
				monitorParam = monitors[i].id;
			else
				monitorParam += ':' + monitors[i].id;
		}	

		console.log(monitorTypes);
		var monitorTypeParam='';
		for (var i = 0; i < monitorTypes.length; i++) {
			if(monitorTypeParam=='')
				monitorTypeParam = monitorTypes[i].id;
			else
				monitorTypeParam += ':' + monitorTypes[i].id;
		}	
				
		var url = "/JSON/HistoryTrend/" + monitorParam + "/" + monitorTypeParam + "/" + reportUnit +"/" +reportStart + "/" + reportEnd;
		
		$.ajax({
			url : url,
			data : "",
			contentType : "application/json; charset=utf-8",
			type : "GET",
			dataType : "json",
			success : function(result) {
				result.colors=[
				'#7CB5EC','#434348','#90ED7D','#F7A35C','#8085E9','#F15C80',
				'#E4D354','#2B908F','#FB9FA8','#91E8E1','#7CB5EC','#80C535','#969696'];
				result.tooltip ={
	            	valueDecimals: 2};
	            result.legend={enabled:true};
				result.credits={
					enabled:false,
					href:'http://www.wecc.com.tw/'
				};
				$('#reportDiv').highcharts(result);
			},
			error : function(xhr, status, errorThrown) {
				console.log("錯誤訊息:" + status + "-" + errorThrown);
			},

			complete : function(xhr, status) {
				$("body").css("cursor", "default");
			}
		});
	});
});
</script>


